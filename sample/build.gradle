plugins {
    id 'org.jetbrains.kotlin.multiplatform'
    id 'org.jetbrains.kotlin.plugin.serialization'

    // KSP gradle plugin used to run the kRPC processor
    id 'com.google.devtools.ksp'
}

// Configure ksp with the kRPC compiler
dependencies {
    // ksp project(":krpc-compiler")
}

kotlin {
    // Kotlin Multiplatform targets
    jvm( {

    })

    sourceSets {
        all {
            // Required to OptIn when using ProtoBuf
            languageSettings.useExperimentalAnnotation 'kotlin.RequiresOptIn'

            // Include code generated by KSP on each platform's source set
            kotlin.srcDir(file("build/generated/ksp/$name/kotlin"))
        }

        commonMain {
            dependencies {
                // Include the kRPC runtime (annotations + coroutines support) for the common module
                implementation project(":krpc-runtime")

                // Serial format shared by all platforms (could be Json, or any other)
                implementation "org.jetbrains.kotlinx:kotlinx-serialization-protobuf:$serializationVersion"

                configurations.getByName("ksp").dependencies.add(project.dependencies.create(project(":krpc-compiler")))
            }
        }

        jvmMain {
            dependencies {
                // JVM-specific dependency used by the grpc-kotlin runtime stubs
                implementation "io.grpc:grpc-netty:$grpcVersion"
            }
        }

        // Test module used in CI
        jvmTest {
            dependencies {
                implementation "org.jetbrains.kotlin:kotlin-test"
            }
        }
    }
}